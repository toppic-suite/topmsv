<!DOCTYPE html>
<html lang="en">
<head>
	<% include ../partials/head %>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js" ></script>
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="js/invokeSpectrum.js" ></script>
	<script src="js/spectrumParameters.js" ></script>
	<script src="js/spectrumGraph.js" ></script>
	<link rel="stylesheet" href="css/jquery-ui.min.css">
</head>
<body class="container">

	<main>
		<div class="jumbotron">
			<h1>Project Summary</h1>
			<h2><ul>
				<li>Project Name: <%= summary.ProjectName %></li>
<!--				<li>Project Status: <%= summary.ProjectStatus %></li>-->
				<li>Email Address: <%= summary.EmailAddress %></li>
				<li>Scan Range: <%= scanRange.MIN %> - <%= scanRange.MAX %></li>
				</ul></h2>
		</div>
		<div class="jumbotron">
			<h2>
				<input type="hidden" id="projectCode" name="projectCode" value="<%= projectCode%>">
				<input type="hidden" id="projectDir" name="projectDir" value="<%= projectDir%>">
				<input type="hidden" id="rangeMin" value=<%= scanRange.MIN %>>
				<input type="hidden" id="rangeMax" value=<%= scanRange.MAX %>>
				Please type in ScanID within Scan Range above: <input type="number" id="scanID" name="scanID" min=<%= scanRange.MIN %> max=<%= scanRange.MAX %>><br>
				<button type="submit" id="request">Request</button>
				</h2>
<!--			<p id="demo"></p>-->
			<!--<svg id="spectrum"></svg>-->
		</div>
		<div class="jumbotron">
			<h2>
				<p><strong>ScanLevel One</strong></p>
				<p>ScanID: <span id="scanID1"></span></p>
				<p id="scanLevel1"></p>
				<button type="submit" id="prev1">Previous</button>
				<button type="submit" id="next1">Next</button>
			</h2>
			<svg id="spectrum1"></svg>
		</div>
		<!--<div class="jumbotron">
			<h2>
				<p><strong>ScanLevel Two</strong></p>
				<p>ScanID: <span id="scanID2"></span></p>
				<p id="scanLevel2"></p>
				<p>Precursor m/z value: <span id="prec_mz"></span></p>
				<button type="submit" id="prev2">Previous</button>
				<button type="submit" id="next2">Next</button>
			</h2>
			<svg id="spectrum2"></svg>
		</div>-->
		<div class="jumbotron" id="tabs">
			<p><strong>ScanLevel Two</strong></p>
			<ul id="tabList">
<!--				<li><a href="#tabs-1">Nunc tincidunt</a></li>-->
<!--				<li><a href="#tabs-2">Proin dolor</a></li>-->
<!--				<li><a href="#tabs-3">Aenean lacinia</a></li>-->
			</ul>
			<div id="tabs-2">
<!--				<p>Morbi tincidunt, dui sit amet facilisis feugiat, odio metus gravida ante, ut pharetra massa metus id nunc. Duis scelerisque molestie turpis. Sed fringilla, massa eget luctus malesuada, metus eros molestie lectus, ut tempus eros massa ut dolor. Aenean aliquet fringilla sem. Suspendisse sed ligula in ligula suscipit aliquam. Praesent in eros vestibulum mi adipiscing adipiscing. Morbi facilisis. Curabitur ornare consequat nunc. Aenean vel metus. Ut posuere viverra nulla. Aliquam erat volutpat. Pellentesque convallis. Maecenas feugiat, tellus pellentesque pretium posuere, felis lorem euismod felis, eu ornare leo nisi vel felis. Mauris consectetur tortor et purus.</p>-->
				<svg id="spectrum3"></svg>
			</div>
		</div>
	</main>
	<script>
/*		var scanTwolist = [];
		function getRelatedScan1(scanID) {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var response = this.responseText;
					if(response !== "0") {
						loadPeakList2(response);
						getPrecMZ(response);
					}else {
						// Empty Tabs
					}
				}
			};
			xhttp.open("GET", "relatedScan1?projectDir=" + document.getElementById("projectDir").value + "&scanID=" + scanID, true);
			xhttp.send();
		}*/
		function getRelatedScan2(scanID) {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var response = this.responseText;
					loadPeakList1(response);
					getScanLevelTwoList(response,scanID);
					//getPrecMZ(scanID);
				}
			};
			xhttp.open("GET", "relatedScan2?projectDir=" + document.getElementById("projectDir").value + "&scanID=" + scanID, true);
			xhttp.send();
		}
		function getScanLevel(scanID) {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var response = this.responseText;
					if (response === "1") {
						loadPeakList1(scanID);
						//getPrecMZ(scanID);
						getScanLevelTwoList(scanID, (parseInt(scanID)+1).toString());
						// getRelatedScan1(scanID);
					}else {
						// loadPeakList2(scanID);
						//getPrecMZ(scanID);
						getRelatedScan2(scanID);
					}
				}
			};
			xhttp.open("GET", "scanlevel?projectDir=" + document.getElementById("projectDir").value + "&scanID=" + scanID, true);
			xhttp.send();
		}
		function getScanID(ID) {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var response = this.responseText;
                    getScanLevel(response);
                }
            };
            xhttp.open("GET", "scanID?projectDir=" + document.getElementById("projectDir").value + "&ID=" + ID, true);
            xhttp.send();
        }
/*        function getPrecMZ(scanID) {
			if (scanID !== '0') {
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function () {
					if (this.readyState == 4 && this.status == 200) {
						var response = this.responseText;
						scanTwolist.push(response);
						//return response;
						//console.log(response);
						//document.getElementById("prec_mz").innerText = response;
					}
				};
				xhttp.open("GET", "precMZ?projectDir=" + document.getElementById("projectDir").value + "&scanID=" + scanID, false);
				xhttp.send();
			}
		}*/
		function loadPeakList1(scanID) {
			if (scanID !== '0') {
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function () {
					if (this.readyState == 4 && this.status == 200) {
						var t3 = performance.now();
						console.log("Call to fetch peaklist1 data from server took " + (t3 - t2) + " milliseconds.");
						var response = JSON.parse(this.responseText);
						document.getElementById("scanID1").innerText = scanID;
						var t0 = performance.now();
						addSpectrum1(response, []);
						var t1 = performance.now();
						console.log("Call to show figure took " + (t1 - t0) + " milliseconds.");
					}
				};
				var t2 = performance.now();
				xhttp.open("GET", "peaklist?projectDir=" + document.getElementById("projectDir").value + "&scanID=" + scanID, true);
				xhttp.send();
			}else{
				alert("NULL");
			}
		}
/*		function loadPeakList2(scanID) {
			if(scanID !== '0') {
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function () {
					if (this.readyState == 4 && this.status == 200) {
						var t5 = performance.now();
						console.log("Call to fetch peaklist2 data from server took " + (t5 - t4) + " milliseconds.");
						var response = JSON.parse(this.responseText);
						document.getElementById("scanID2").innerText = scanID;
						//getPrecMZ(scanID);
						var t6 = performance.now();
						addSpectrum2(response, []);
						var t7 = performance.now();
						console.log("Call to show figure took " + (t7 - t6) + " milliseconds.");
					}
				};
				var t4 = performance.now();
				xhttp.open("GET", "peaklist?projectDir=" + document.getElementById("projectDir").value + "&scanID=" + scanID, true);
				xhttp.send();
			}else{
				alert("NULL");
			}
		}*/
		function loadPeakList3(scanID) {
			if(scanID !== '0') {
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function () {
					if (this.readyState == 4 && this.status == 200) {
						var t5 = performance.now();
						console.log("Call to fetch peaklist2 data from server took " + (t5 - t4) + " milliseconds.");
						var response = JSON.parse(this.responseText);
						// document.getElementById("scanID2").innerText = scanID;
						//getPrecMZ(scanID);
						var t6 = performance.now();
						addSpectrum3(response, []);
						var t7 = performance.now();
						console.log("Call to show figure took " + (t7 - t6) + " milliseconds.");
					}
				};
				var t4 = performance.now();
				xhttp.open("GET", "peaklist?projectDir=" + document.getElementById("projectDir").value + "&scanID=" + scanID, true);
				xhttp.send();
			}else{
				alert("NULL");
			}
		}
		function prev(scanID) {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					//console.log("Call to fetch prev id from server took " + (t5 - t4) + " milliseconds.");
					var response = this.responseText;
					if(response !== '0'){
						getScanID(response);
					}else {
						$( "#spectrum1" ).empty();
						$( "#spectrum3" ).empty();
						$("#scanID1").empty();
						alert("NULL");
					}
				}
			};
			xhttp.open("GET", "prev?projectDir=" + document.getElementById("projectDir").value + "&scanID=" + scanID, true);
			xhttp.send();
		}
		function next(scanID) {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					//console.log("Call to fetch next id from server took " + (t7 - t6) + " milliseconds.");
					var response = this.responseText;
					if(response !== '0') {
						getScanID(response);
					}else {
						$("#spectrum1" ).empty();
						$("#spectrum3" ).empty();
						$("#scanID1").empty();
						alert("NULL");
					}
				}
			};
			xhttp.open("GET", "next?projectDir=" + document.getElementById("projectDir").value + "&scanID=" + scanID, true);
			xhttp.send();
		}
		function getScanLevelTwoList(scanID,target) {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					var response = JSON.parse(this.responseText);
					console.log(response);
					// $("#tabs li").remove();
					$( "#tabs" ).tabs();
					$("#tabs li").remove();
					$( "#tabs" ).tabs("destroy");
					// var tabs = $( "#tabs" ).tabs();
					// var ul = tabs.find( "ul" );
					response.forEach(function (item) {
						//console.log(item.scanID);
						//getPrecMZ(item.scanID);
						var scanTwoNum = item.scanID;
						$("#tabs ul").append('<li><a href="#spectrum3"' + ' id='+ scanTwoNum + ' onclick="loadPeakList3(' + scanTwoNum+')">'+ item.prec_mz + '</a></li>');
						// $( '<li><a href="#spectrum3" class="ui-icon ui-icon-close role=\'presentation\'" onclick="loadPeakList3(' + scanTwoNum + ')">'+ item.prec_mz + '</a></li>' ).appendTo( ul );
					});
					$( "#tabs" ).tabs();
/*
					console.log(scanID);
					console.log(document.getElementById(scanID));
*/
					console.log(target);
/*
					var showID = (parseInt(scanID) + 1).toString(10);
					console.log(showID);
					console.log(document.getElementById(showID));
*/
					document.getElementById(target).click();
					// $( "#tabs" ).tabs( "load", 0 );
					// var i = 0;
					// scanTwolist.forEach(function (scan) {
					// 	$("#tabs ul").append('<li><a href="#tabs-2" onclick="loadPeakList3(response[i].scanID)">'+ scan + '</a></li>');
					// 	i++;
					// })
					// loadPeakList3(response[0].scanID);
					//console.log(scanTwolist);
					//getPrecMZ(scanID);
				}
			};
			xhttp.open("GET", "scanTwoList?projectDir=" + document.getElementById("projectDir").value + "&scanID=" + scanID, true);
			xhttp.send();
		}
		var requestButton = document.getElementById('request');
		requestButton.addEventListener('click', function () {
			$( "#spectrum3" ).empty();
			var requestID = document.getElementById("scanID").value;
			var min = document.getElementById("rangeMin").value;
			var max = document.getElementById("rangeMax").value;
			if(parseInt(requestID) >= parseInt(min) && parseInt(requestID) <= parseInt(max)) {
				//console.log("Yes");
				getScanLevel(document.getElementById("scanID").value);
				$("#scanID").val("");
			}else {
				//console.log("No");
				alert("Please type in one scanID within range!")
			}

			// getScanLevelTwoList(document.getElementById("scanID").value);
		},false)
		var prev1 = document.getElementById('prev1');
		prev1.addEventListener('click', function () {
			$( "#spectrum3" ).empty();
			$("#tabList").empty();
			var scanID1 = document.getElementById("scanID1").innerHTML;
			if (scanID1 !== '') {
				prev(document.getElementById("scanID1").innerHTML);
			}
		},false)
		var next1 = document.getElementById('next1');
		next1.addEventListener('click', function () {
			$( "#spectrum3" ).empty();
			$("#tabList").empty();
			var scanID1 = document.getElementById("scanID1").innerHTML;
			if (scanID1 !== '') {
				next(document.getElementById("scanID1").innerHTML);
			}
		},false)
/*		var prev2 = document.getElementById('prev2');
		prev2.addEventListener('click', function () {
			prev(document.getElementById("scanID2").innerHTML);
		},false)
		var next2 = document.getElementById('next2');
		next2.addEventListener('click', function () {
			next(document.getElementById("scanID2").innerHTML);
		},false)*/
	</script>
</body>
</html>